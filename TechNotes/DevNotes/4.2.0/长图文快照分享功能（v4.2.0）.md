# 长图文快照分享功能

###### 1.同类功能APP：
- 小红书
- 简书
- 百度地图



###### 2.逻辑分析、功能点拆分

提前下载好图片、计算整体高度、添加并排版 view(图片、富文本文字、二维码生成)、绘图、尺寸调整、体积压缩、预览？、保存到相册

耗时：3天

**其他思路：**

- 服务端提供图片 url
   所需要的快照包含元素多，服务端的图片由谁提供？如果需要人工做图，再上传到服务器，使用时再去下载，成本反而更大，体验也会下降，服务器的压力也会增大。
   
- YHouse 邀请函（`YHMineInvitationLetterController`）
   在 UIWebView 中加载数据，渲染 view，生成快照时将 webView 中 scrollView 的 frame 展开跟 contentSize 一样大进行内容绘制，得到图片，然后再将  webView 中 scrollView 还原，最后贴上二维码，检测图片体积大小进行压缩限制。

###### 3.注意点、边界条件、限制条件、容错

**图片高宽比过大（裁剪原图、或者在排版显示时只显示中间部分）**、**图片体积大小（微信要求最大 10 M、防止 OOM、分享限制条件）**、下载图片失败（失败提示）、网络中断、版本适配（机型、分辨率、API）、分享链接为空（失败提示）、所耗时间（图片下载+绘制+可选压缩）

###### 4.可扩展性、前瞻性

二维码的样式、预览

###### 5.参考资料：

1.[各个社交平台的分享授权规则](http://wiki.mob.com/平台特殊性/)

2.[iOS截图（1）生成分享图片](http://www.jianshu.com/p/7c8e7e5102bc)

3.[iOS截图（2）生成长图](http://www.jianshu.com/p/9215f8860af5)

非滚动视图的快照：创建一个 view，布局所有要分享的内容 ——> 生成图片 ——> 图片尺寸调整
滚动视图（webView）的快照：基于上面的非滚动视图的快照方案，分段绘制 webView 上的内容 ——> 再拼接图片

4.[Android应用内截图分享的实现记录](http://www.jianshu.com/p/ae160dfe3c4f)

流程：展示 view -> 转成 bitmap
注意点：避免主线程阻塞，内存使用问题

5.[kingsic/SGQRCode](https://github.com/kingsic/SGQRCode)

###### 6.拓展延伸
1.【产品】长图文快照需求  
2.【技术】截取部分内容生成图片
[iOS截图（3）截取网页片段](http://www.jianshu.com/p/ef50defb979d)
[实现仿简书选取内容生成分享图片效果](http://www.jianshu.com/p/c34aad68bf46)



###### 7.bug 汇总

图片显示适配问题，截出来的图都是宽度为 640 px 的图，那么在创建 view 时加载的图片资源（@2x，@3x） 应该怎么给？

理论上 @2x，@3x 只是为了针对不同屏幕的显示渲染做的区分，实际上对于固定尺寸的 off-screen 截图来说，@2x，@3x 的图像素尺寸都是一样的就可以了。

